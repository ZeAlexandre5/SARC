{% extends 'SARC/base.html' %}
{% load static %}
{% block content %}

    <div class="container">
        <h1>Reserva de Salas de Informática</h1>
        
       
        <div class="section">
            <h2>Computadores Disponíveis</h2>
            <div id="labRooms" class="lab-rooms-container">
                <!-- Os computadores serão renderizados aqui via JavaScript -->
            </div>
        </div>
    
        <!-- Formulário de reserva -->
        <div class="section">
            <h2>Detalhes da Reserva</h2>
            <form method="post" id="reservationForm">
                {% csrf_token %}
                {{ form.non_field_errors }}
                {{ form.sala }} <!-- hidden -->
                
                <div class="mb-3">
                    <label class="form-label">{{ form.data.label }}</label>
                    {{ form.data }}
                    {{ form.data.errors }}
                </div>
                
                <div class="mb-3">
                    <label class="form-label">{{ form.horario.label }}</label>
                    {{ form.horario }}
                    {{ form.horario.errors }}
                </div>
                
                <div class="mb-3">
                    <label class="form-label">{{ form.computador.label }}</label>
                    {{ form.computador }}
                    {{ form.computador.errors }}
                    <small class="form-text text-muted">Ou selecione diretamente no mapa acima</small>
                </div>
                
                <div class="mb-3">
                    <label class="form-label">{{ form.motivo.label }}</label>
                    {{ form.motivo }}
                    {{ form.motivo.errors }}
                </div>
                
                <button type="submit" class="btn btn-primary">Confirmar Reserva</button>
            </form>
        </div>
    </div>
    
    <style>
        .lab-rooms-container {
            display: grid;
            gap: 20px;
            margin-bottom: 30px;
        }
    
        .lab-room {
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 15px;
            background-color: #f9f9f9;
        }
    
        .lab-room h3 {
            margin-top: 0;
            color: #333;
            border-bottom: 2px solid #007bff;
            padding-bottom: 8px;
        }
    
        .computers {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(60px, 1fr));
            gap: 10px;
            margin-top: 15px;
        }
    
        .computer {
            width: 60px;
            height: 60px;
            border: 2px solid #28a745;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            position: relative;
            background-color: #fff;
            transition: all 0.3s ease;
        }
    
        .computer:hover {
            transform: scale(1.05);
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }
    
        .computer.available {
            border-color: #28a745;
            background-color: #d4edda;
        }
    
        .computer.reserved {
            border-color: #dc3545;
            background-color: #f8d7da;
            cursor: not-allowed;
        }
    
        .computer.selected {
            border-color: #007bff;
            background-color: #cce7ff;
            box-shadow: 0 0 0 3px rgba(0,123,255,0.3);
        }
    
        .computer .tooltip {
            position: absolute;
            bottom: -30px;
            left: 50%;
            transform: translateX(-50%);
            background: #333;
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            white-space: nowrap;
            opacity: 0;
            transition: opacity 0.3s;
            pointer-events: none;
        }
    
        .computer:hover .tooltip {
            opacity: 1;
        }
    
        .computer span {
            font-weight: bold;
            color: #333;
        }
    
        .small-room .computers {
            grid-template-columns: repeat(auto-fill, minmax(80px, 1fr));
        }
    
        .time-slot {
            padding: 10px;
            margin: 5px;
            border: 1px solid #ddd;
            border-radius: 4px;
            cursor: pointer;
            display: inline-block;
        }
    
        .time-slot.selected {
            background-color: #007bff;
            color: white;
            border-color: #007bff;
        }
    
        .time-slot.unavailable {
            background-color: #f8d7da;
            color: #721c24;
            border-color: #f5c6cb;
            cursor: not-allowed;
        }
    </style>
    
    <script>
        // Dados das salas e computadores (vindos do Django)
        const database = {
            reservations: [],
            rooms: [
                {% for computador in computadores %}
                {
                    id: {{ computador.sala.id_sala }},
                    name: '{{ computador.sala.nome }}',
                    computers: [
                        {% for comp in computadores %}
                        {% if comp.sala.id_sala == computador.sala.id_sala %}
                        {
                            id: {{ comp.id_computador }},
                            number: '{{ comp.numero }}',
                            state: '{{ comp.estado }}',
                            roomId: {{ comp.sala.id_sala }}
                        },
                        {% endif %}
                        {% endfor %}
                    ],
                    layout: 'normal'
                },
                {% endfor %}
            ],
            timeSlots: [
                '07:00 - 08:30',
                '08:50 - 10:20',
                '10:30 - 12:00',
                '13:00 - 14:30',
                '14:50 - 16:20',
                '16:30 - 18:00',
            ]
        };
    
        // Inicializa a página
        document.addEventListener('DOMContentLoaded', function() {
            renderLabRooms();
            setupEventListeners();
            
            // Sincroniza o select do formulário com o select visual
            const timeSelect = document.getElementById('timeSelect');
            const formHorario = document.getElementById('id_horario');
            
            if (timeSelect && formHorario) {
                timeSelect.addEventListener('change', function() {
                    formHorario.value = this.value;
                    updateComputerAvailability(this.value);
                });
            }
        });
    
        // Renderiza as salas de informática
        function renderLabRooms() {
            const labRoomsContainer = document.getElementById('labRooms');
            labRoomsContainer.innerHTML = '';
            
            database.rooms.forEach(room => {
                const roomElement = document.createElement('div');
                roomElement.className = `lab-room ${room.layout === 'small' ? 'small-room' : ''}`;
                roomElement.id = 'room-' + room.id;
                
                const roomTitle = document.createElement('h3');
                roomTitle.textContent = `Sala ${room.name} - ${room.computers.length} computadores`;
                roomElement.appendChild(roomTitle);
                
                const computersContainer = document.createElement('div');
                computersContainer.className = 'computers';
                
                room.computers.forEach(computer => {
                    const computerElement = document.createElement('div');
                    computerElement.className = `computer ${computer.state === 'Disponível' ? 'available' : 'reserved'}`;
                    computerElement.dataset.computerId = computer.id;
                    computerElement.dataset.roomId = computer.roomId;
                    
                    const computerNumber = document.createElement('span');
                    computerNumber.textContent = computer.number;
                    computerElement.appendChild(computerNumber);
                    
                    const tooltip = document.createElement('span');
                    tooltip.className = 'tooltip';
                    tooltip.textContent = computer.state;
                    computerElement.appendChild(tooltip);
                    
                    computersContainer.appendChild(computerElement);
                });
                
                roomElement.appendChild(computersContainer);
                labRoomsContainer.appendChild(roomElement);
            });
        }
    
        // Configura os event listeners
        function setupEventListeners() {
            // Seleção de computador
            document.addEventListener('click', function(e) {
                const computerElement = e.target.closest('.computer');
                
                if (computerElement && computerElement.classList.contains('available')) {
                    const roomId = computerElement.dataset.roomId;
                    const computerId = computerElement.dataset.computerId;
                    const timeSlot = document.getElementById('timeSelect').value;
                    
                    if (!timeSlot) {
                        alert('Por favor, selecione um horário primeiro.');
                        return;
                    }
                    
                    // Remove seleção anterior
                    document.querySelectorAll('.computer').forEach(comp => {
                        comp.classList.remove('selected');
                    });
                    
                    // Marca como selecionado
                    computerElement.classList.add('selected');
                    
                    // Preenche o campo computador no formulário
                    const computadorField = document.getElementById('id_computador');
                    if (computadorField) {
                        computadorField.value = computerId;
                    }
                    
                    // Rola até o formulário
                    document.getElementById('reservationForm').scrollIntoView({ 
                        behavior: 'smooth', 
                        block: 'start' 
                    });
                }
            });
        }
    
        // Atualiza a disponibilidade dos computadores com base no horário selecionado
        function updateComputerAvailability(selectedTime) {
            // Esta função pode ser expandida para verificar reservas existentes
            console.log('Horário selecionado:', selectedTime);
            
            // Por enquanto, apenas mostra todos os computadores como disponíveis
            // Você pode adicionar lógica para verificar reservas no banco de dados
            document.querySelectorAll('.computer').forEach(computer => {
                const isReserved = false; // Substituir por verificação real no banco
                if (isReserved) {
                    computer.className = 'computer reserved';
                    computer.querySelector('.tooltip').textContent = 'Reservado';
                } else {
                    computer.className = 'computer available';
                    computer.querySelector('.tooltip').textContent = 'Disponível';
                }
            });
        }
    </script>
    
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

{% endblock %}