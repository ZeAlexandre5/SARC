{% extends 'SARC/base.html' %}
{% load static %}
{% block content %}

    <div class="container">
        <h1>Reserva de Salas de Informática</h1>
        
        <div class="section">
            <h2>Selecione o Horário</h2>
                <!-- Horários serão preenchidos via JavaScript -->
                 <select name="time">
                    <option value="time1">07:00 - 08:30</option>
                    <option value="time2">08:50 - 10:20</option>
                    <option value="time3">10:30 - 12:00</option>
                    <option value="time4">13:00 - 14:30</option>
                    <option value="time5">14:50 - 16:20</option>
                    <option value="time6">16:30 - 18:00</option>
                  </select>
            </div>
        </div>
        <div class="section">
            <h2>Detalhes da Reserva</h2>
            <form method="post">
                {% csrf_token %}
                {{ form.non_field_errors }}
                {{ form.sala }} <!-- hidden -->
                <div class="mb-3">
                  <label class="form-label">{{ form.data.label }}</label>
                  {{ form.data }}
                  {{ form.data.errors }}
                </div>
                <div class="mb-3">
                  <label class="form-label">{{ form.horario.label }}</label>
                  {{ form.horario }}
                  {{ form.horario.errors }}
                </div>
                <div class="mb-3">
                  <label class="form-label">{{ form.computador.label }}</label>
                  {{ form.computador }}
                  {{ form.computador.errors }}
                </div>
                <div class="mb-3">
                  <label class="form-label">{{ form.motivo.label }}</label>
                  {{ form.motivo }}
                  {{ form.motivo.errors }}
                </div>
                <button type="submit" class="btn btn-primary">Confirmar Reserva</button>
              </form>
        </div>
    </div>


 <script>
        // Dados simulados do banco de dados
        const database = {
            reservations: [],
            rooms: [
                { id: 1, name: '203', computers: 30, layout: 'normal' },
                { id: 2, name: '204', computers: 30, layout: 'normal' },
                { id: 3, name: '206', computers: 30, layout: 'normal' },
                { id: 4, name: '214', computers: 30, layout: 'normal' },
                { id: 5, name: 'sala de estudos', computers: 5, layout: 'small' }
            ],
            timeSlots: [
                '07:00 - 08:30',
                '08:50 - 10:20',
                '10:30 - 12:00',
                '13:00 - 14:30',
                '14:50 - 16:20',
                '16:30 - 18:00',
            ]
        };

        // Inicializa a página
        document.addEventListener('DOMContentLoaded', function() {
            renderTimeSlots();
            renderLabRooms();
            setupEventListeners();
        });

        // Renderiza os horários disponíveis
        function renderTimeSlots() {
            const timeSlotsContainer = document.getElementById('timeSlots');
            timeSlotsContainer.innerHTML = '';
            
            database.timeSlots.forEach(timeSlot => {
                const timeSlotElement = document.createElement('div');
                timeSlotElement.className = 'time-slot';
                timeSlotElement.textContent = timeSlot;
                timeSlotElement.dataset.time = timeSlot;
                timeSlotsContainer.appendChild(timeSlotElement);
            });
        }

        // Renderiza as salas de informática
        function renderLabRooms() {
            const labRoomsContainer = document.getElementById('labRooms');
            labRoomsContainer.innerHTML = '';
            
            database.rooms.forEach(room => {
                const roomElement = document.createElement('div');
                roomElement.className = `lab-room ${room.layout === 'small' ? 'small-room' : ''}`;
                roomElement.id = room.id;
                
                const roomTitle = document.createElement('h3');
                roomTitle.textContent = room.name;
                roomElement.appendChild(roomTitle);
                
                const computersContainer = document.createElement('div');
                computersContainer.className = 'computers';
                
                for (let i = 1; i <= room.computers; i++) {
                    const computerElement = document.createElement('div');
                    computerElement.className = 'computer available';
                    computerElement.dataset.computerId = i;
                    computerElement.dataset.roomId = room.id;
                    
                    const computerNumber = document.createElement('span');
                    computerNumber.textContent = i;
                    computerElement.appendChild(computerNumber);
                    
                    const tooltip = document.createElement('span');
                    tooltip.className = 'tooltip';
                    tooltip.textContent = 'Disponível';
                    computerElement.appendChild(tooltip);
                    
                    computersContainer.appendChild(computerElement);
                }
                
                roomElement.appendChild(computersContainer);
                labRoomsContainer.appendChild(roomElement);
            });
        }

        // Configura os event listeners
        function setupEventListeners() {
            // Seleção de horário
            document.querySelectorAll('.time-slot').forEach(slot => {
                slot.addEventListener('click', function() {
                    if (this.classList.contains('unavailable')) return;
                    
                    // Remove seleção anterior
                    document.querySelectorAll('.time-slot').forEach(s => {
                        s.classList.remove('selected');
                    });
                    
                    // Marca como selecionado
                    this.classList.add('selected');
                    
                    // Atualiza a disponibilidade dos computadores
                    updateComputerAvailability(this.dataset.time);
                });
            });
            
            // Seleção de computador
            document.addEventListener('click', function(e) {
                if (e.target.classList.contains('computer') && e.target.classList.contains('available')) {
                    const roomId = e.target.dataset.roomId;
                    const computerId = e.target.dataset.computerId;
                    const timeSlot = document.querySelector('.time-slot.selected')?.dataset.time;
                    
                    if (!timeSlot) {
                        alert('Por favor, selecione um horário primeiro.');
                        return;
                    }
                    
                    // Mostra o formulário de reserva
                    document.getElementById('reservationForm').style.display = 'block';
                    document.getElementById('selectedRoom').value = roomId;
                    document.getElementById('selectedComputer').value = computerId;
                    document.getElementById('selectedTime').value = timeSlot;
                    
                    // Rola até o formulário
                    document.getElementById('reservationForm').scrollIntoView({ behavior: 'smooth' });
                }
            });
            
            // Motivo da reserva
            document.getElementById('reservationReason').addEventListener('change', function() {
                const otherReasonGroup = document.getElementById('otherReasonGroup');
                otherReasonGroup.style.display = this.value === 'outro' ? 'block' : 'none';
            });
            
            // Envio do formulário
            document.getElementById('reservationDetails').addEventListener('submit', function(e) {
                e.preventDefault();
                
                const reservation = {
                    roomId: document.getElementById('selectedRoom').value,
                    computerId: document.getElementById('selectedComputer').value,
                    timeSlot: document.getElementById('selectedTime').value,
                    studentName: document.getElementById('studentName').value,
                    studentId: document.getElementById('studentId').value,
                    reason: document.getElementById('reservationReason').value,
                    otherReason: document.getElementById('otherReason').value,
                    notes: document.getElementById('reservationNotes').value,
                    date: new Date().toISOString()
                };
                
                // Simula o envio para o banco de dados
                database.reservations.push(reservation);
                
                // Atualiza a interface
                updateComputerAvailability(reservation.timeSlot);
                
                // Limpa o formulário
                this.reset();
                document.getElementById('reservationForm').style.display = 'none';
                
                // Mostra mensagem de sucesso
                alert('Reserva realizada com sucesso!');
            });
        }

        // Atualiza a disponibilidade dos computadores com base no horário selecionado
        function updateComputerAvailability(selectedTime) {
            // Limpa todas as marcações de disponibilidade
            document.querySelectorAll('.computer').forEach(computer => {
                computer.className = 'computer available';
                computer.querySelector('.tooltip').textContent = 'Disponível';
            });
            
            // Marca os computadores reservados para o horário selecionado
            database.reservations.forEach(reservation => {
                if (reservation.timeSlot === selectedTime) {
                    const computer = document.querySelector(`.computer[data-room-id="${reservation.roomId}"][data-computer-id="${reservation.computerId}"]`);
                    if (computer) {
                        computer.className = 'computer reserved';
                        computer.querySelector('.tooltip').textContent = 'Reservado';
                    }
                }
            });
        }
    </script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

{% endblock %}